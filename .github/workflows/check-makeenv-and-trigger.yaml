name: Check make.env Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯ä¸¤å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          echo "MAKEENV_URL=https://raw.githubusercontent.com/unifreq/openwrt_packit/0a8e64cd58d5641b6e58caed59c1ac9c79c7b23c/make.env" >> $GITHUB_ENV
          echo "TEMP_SHA_PATH=./current.sha" >> $GITHUB_ENV
          echo "ARTIFACT_DIR=.sha" >> $GITHUB_ENV
          echo "PREV_SHA_PATH=.sha/previous.sha" >> $GITHUB_ENV

      - name: Download make.env from remote
        run: |
          echo "Downloading make.env from $MAKEENV_URL"
          curl -fsSL "$MAKEENV_URL" -o make.env

      - name: Calculate SHA256 of make.env
        id: sha
        run: |
          sha256sum make.env | awk '{print $1}' > $TEMP_SHA_PATH
          echo "âœ… Current SHA: $(cat $TEMP_SHA_PATH)"

      - name: Prepare artifact directory
        run: mkdir -p $ARTIFACT_DIR

      - name: Try to download previous SHA artifact (with retry)
  run: |
    success=false
    for i in {1..3}; do
      echo "Attempt $i: Downloading makeenv-sha artifact..."
      gh run download -n makeenv-sha -D $ARTIFACT_DIR && success=true && break
      echo "Retrying in 10 seconds..."
      sleep 10
    done
    if [ "$success" = false ]; then
      echo "Warning: Still failed to download artifact. Assuming first run."
    fi
  continue-on-error: true
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Compare SHA to detect changes
        id: compare
        run: |
          echo "should_save_artifact=false" >> $GITHUB_OUTPUT
          echo "should_trigger_build=false" >> $GITHUB_OUTPUT

          if [ ! -f "$PREV_SHA_PATH" ]; then
            echo "ğŸ†• First run detected. Saving SHA only, not triggering build."
            echo "should_save_artifact=true" >> $GITHUB_OUTPUT
          elif ! cmp -s "$PREV_SHA_PATH" "$TEMP_SHA_PATH"; then
            echo "âœ… SHA changed - triggering build"
            echo "should_save_artifact=true" >> $GITHUB_OUTPUT
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
          else
            echo "â¹ No changes detected in make.env"
          fi

      - name: Save current SHA as file
        if: steps.compare.outputs.should_save_artifact == 'true'
        run: cp $TEMP_SHA_PATH $ARTIFACT_DIR/previous.sha

      - name: Verify saved SHA content
        if: steps.compare.outputs.should_save_artifact == 'true'
        run: |
          echo "ğŸ“„ SHA written to artifact:"
          cat $ARTIFACT_DIR/previous.sha
          ls -l $ARTIFACT_DIR

      - name: Upload new SHA artifact
        if: steps.compare.outputs.should_save_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: makeenv-sha
          path: .sha/previous.sha   # âœ… ç›´æ¥æŒ‡å®šæ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ å¤±è´¥
          retention-days: 7

      - name: Trigger kernel build workflow
        if: steps.compare.outputs.should_trigger_build == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel  # âš ï¸ è¯·ç¡®è®¤ workflow åç§°
          token: ${{ secrets.GITHUB_TOKEN }}
