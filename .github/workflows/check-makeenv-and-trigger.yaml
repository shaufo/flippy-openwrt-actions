name: Check Kernel Makefile Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'  # 每两小时检查一次
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    env:
      FILE_612_URL: https://raw.githubusercontent.com/unifreq/linux-6.12.y/refs/heads/main/Makefile
      FILE_66_URL: https://raw.githubusercontent.com/unifreq/linux-6.6.y/refs/heads/main/Makefile
      FILE_612_NAME: Makefile_6.12
      FILE_66_NAME: Makefile_6.6
      SHA_DIR: .sha
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Makefiles
        run: |
          echo "📥 Downloading Makefiles..."
          curl -fsSL "$FILE_612_URL" -o "$FILE_612_NAME"
          curl -fsSL "$FILE_66_URL" -o "$FILE_66_NAME"

      - name: Calculate SHA256 of Makefiles
        run: |
          mkdir -p "${{ env.SHA_DIR }}"
          sha256sum "${{ env.FILE_612_NAME }}" | awk '{print $1}' > "${{ env.SHA_DIR }}/current_612.sha"
          sha256sum "${{ env.FILE_66_NAME }}" | awk '{print $1}' > "${{ env.SHA_DIR }}/current_66.sha"
          echo "✅ SHA 6.12: $(cat ${{ env.SHA_DIR }}/current_612.sha)"
          echo "✅ SHA 6.6 : $(cat ${{ env.SHA_DIR }}/current_66.sha)"

      - name: Download previous SHA artifacts (ignore errors)
        continue-on-error: true
        run: |
          mkdir -p "${{ env.SHA_DIR }}"
          gh run download -n makefile-6.12-sha -D "${{ env.SHA_DIR }}" || echo "⚠️ No previous 6.12 SHA"
          gh run download -n makefile-6.6-sha -D "${{ env.SHA_DIR }}" || echo "⚠️ No previous 6.6 SHA"
          # Rename to match expected filenames
          [ -f "${{ env.SHA_DIR }}/previous.sha" ] && mv "${{ env.SHA_DIR }}/previous.sha" "${{ env.SHA_DIR }}/previous_612.sha"
          [ -f "${{ env.SHA_DIR }}/previous (1).sha" ] && mv "${{ env.SHA_DIR }}/previous (1).sha" "${{ env.SHA_DIR }}/previous_66.sha"

      - name: Compare SHAs and decide whether to trigger build
        id: compare
        run: |
          echo "should_trigger_build=false" >> $GITHUB_OUTPUT
          changed=false

          if [ ! -f "${{ env.SHA_DIR }}/previous_612.sha" ]; then
            echo "🆕 First run for 6.12"
            mv "${{ env.SHA_DIR }}/current_612.sha" "${{ env.SHA_DIR }}/previous_612.sha"
            changed=true
          elif ! cmp -s "${{ env.SHA_DIR }}/previous_612.sha" "${{ env.SHA_DIR }}/current_612.sha"; then
            echo "🔁 Detected change in 6.12"
            mv "${{ env.SHA_DIR }}/current_612.sha" "${{ env.SHA_DIR }}/previous_612.sha"
            changed=true
          fi

          if [ ! -f "${{ env.SHA_DIR }}/previous_66.sha" ]; then
            echo "🆕 First run for 6.6"
            mv "${{ env.SHA_DIR }}/current_66.sha" "${{ env.SHA_DIR }}/previous_66.sha"
            changed=true
          elif ! cmp -s "${{ env.SHA_DIR }}/previous_66.sha" "${{ env.SHA_DIR }}/current_66.sha"; then
            echo "🔁 Detected change in 6.6"
            mv "${{ env.SHA_DIR }}/current_66.sha" "${{ env.SHA_DIR }}/previous_66.sha"
            changed=true
          fi

          if [ "$changed" = true ]; then
            echo "✅ Build should be triggered"
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
          else
            echo "⏹ No changes detected"
          fi

      - name: Upload SHA for 6.12
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: makefile-6.12-sha
          path: ${{ env.SHA_DIR }}/previous_612.sha
          retention-days: 7

      - name: Upload SHA for 6.6
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: makefile-6.6-sha
          path: ${{ env.SHA_DIR }}/previous_66.sha
          retention-days: 7

      - name: Trigger kernel build workflow
        if: steps.compare.outputs.should_trigger_build == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel  # ✅ 请确认名称是否匹配
          token: ${{ secrets.GITHUB_TOKEN }}
