name: Check Makefile Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

env:
  FILE_612_URL: https://raw.githubusercontent.com/unifreq/linux-6.12.y/main/Makefile
  FILE_66_URL: https://raw.githubusercontent.com/unifreq/linux-6.6.y/main/Makefile
  SHA_DIR: .sha
  SHA_FILE_612: .sha/Makefile_6.12.sha
  SHA_FILE_66: .sha/Makefile_6.6.sha
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-makefile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository (default branch)
        uses: actions/checkout@v3

      - name: Checkout `sha-cache` branch
        run: |
          git fetch origin sha-cache:sha-cache || git checkout -b sha-cache
          git worktree add sha-cache-dir sha-cache

      - name: 📥 Download latest Makefiles
        run: |
          curl -fsSL "$FILE_612_URL" -o makefile_612
          curl -fsSL "$FILE_66_URL" -o makefile_66

      - name: 🧮 Calculate current SHA256
        run: |
          mkdir -p "$SHA_DIR"
          sha256sum makefile_612 | awk '{print $1}' > $SHA_FILE_612
          sha256sum makefile_66 | awk '{print $1}' > $SHA_FILE_66

      - name: 🔍 Compare with cached SHA
        id: compare
        run: |
          echo "should_trigger_build=false" >> $GITHUB_OUTPUT
          echo "should_update_612=false" >> $GITHUB_OUTPUT
          echo "should_update_66=false" >> $GITHUB_OUTPUT

          if [ ! -f sha-cache-dir/Makefile_6.12.sha ] || ! cmp -s "$SHA_FILE_612" sha-cache-dir/Makefile_6.12.sha; then
            echo "📌 6.12 Makefile changed"
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
            echo "should_update_612=true" >> $GITHUB_OUTPUT
          fi

          if [ ! -f sha-cache-dir/Makefile_6.6.sha ] || ! cmp -s "$SHA_FILE_66" sha-cache-dir/Makefile_6.6.sha; then
            echo "📌 6.6 Makefile changed"
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
            echo "should_update_66=true" >> $GITHUB_OUTPUT
          fi

      - name: 💾 Update SHA cache (if needed)
        if: steps.compare.outputs.should_trigger_build == 'true'
        run: |
          if [ "${{ steps.compare.outputs.should_update_612 }}" = "true" ]; then
            cp "$SHA_FILE_612" sha-cache-dir/Makefile_6.12.sha
          fi
          if [ "${{ steps.compare.outputs.should_update_66 }}" = "true" ]; then
            cp "$SHA_FILE_66" sha-cache-dir/Makefile_6.6.sha
          fi

          cd sha-cache-dir
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add *.sha
          git commit -m "Update SHA cache on $(date +%F-%T)" || echo "No changes"
          git push origin HEAD:sha-cache

      - name: 🚀 Trigger kernel build
        if: steps.compare.outputs.should_trigger_build == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel
          token: ${{ secrets.GITHUB_TOKEN }}
