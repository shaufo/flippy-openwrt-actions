name: Check Makefile Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'  # 每 2 小时执行一次
  workflow_dispatch:

env:
  FILE_612_URL: https://raw.githubusercontent.com/unifreq/linux-6.12.y/main/Makefile

jobs:
  check-makefile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Load original SHA from repo
        run: |
          cp sha_6.12.txt sha_6.12.txt.orig || touch sha_6.12.txt.orig

      - name: Download Makefile 6.12
        run: |
          curl -fsSL "$FILE_612_URL" -o makefile_612

      - name: Calculate SHA256 of downloaded Makefile 6.12
        run: |
          sha256sum makefile_612 | awk '{print $1}' > sha_6.12.txt
          echo "New SHA 6.12: $(cat sha_6.12.txt)"

      - name: Compare SHA file
        id: compare
        run: |
          changed=false

          if ! cmp -s sha_6.12.txt sha_6.12.txt.orig; then
            echo "SHA 6.12 changed"
            changed=true
          else
            echo "SHA 6.12 unchanged"
          fi

          echo "changed=${changed}" >> "$GITHUB_ENV"

      - name: Commit and push updated SHA file if changed
        if: env.changed == 'true'
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"

          git add sha_6.12.txt
          git commit -m "Update SHA 6.12 on $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push

      - name: Trigger kernel build workflow
        if: env.changed == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel
          token: ${{ secrets.GITHUB_TOKEN }}
