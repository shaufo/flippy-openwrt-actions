name: Check Kernel Makefile Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯ä¸¤å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    env:
      FILE_612_URL: https://raw.githubusercontent.com/unifreq/linux-6.12.y/refs/heads/main/Makefile
      FILE_66_URL: https://raw.githubusercontent.com/unifreq/linux-6.6.y/refs/heads/main/Makefile
      FILE_612_NAME: Makefile_6.12
      FILE_66_NAME: Makefile_6.6
      SHA_DIR: .sha
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Makefiles
        run: |
          echo "ğŸ“¥ Downloading Makefiles..."
          curl -fsSL "$FILE_612_URL" -o $FILE_612_NAME
          curl -fsSL "$FILE_66_URL" -o $FILE_66_NAME

      - name: Calculate SHA256 of Makefiles
        run: |
          mkdir -p $SHA_DIR
          sha256sum $FILE_612_NAME | awk '{print $1}' > $SHA_DIR/current_612.sha
          sha256sum $FILE_66_NAME | awk '{print $1}' > $SHA_DIR/current_66.sha
          echo "âœ… SHA 6.12: $(cat $SHA_DIR/current_612.sha)"
          echo "âœ… SHA 6.6 : $(cat $SHA_DIR/current_66.sha)"

      - name: Download previous SHA artifacts
        continue-on-error: true
        run: |
          mkdir -p $SHA_DIR
          for name in makefile-6.12-sha makefile-6.6-sha; do
            echo "â¬‡ï¸ Attempting to download $name"
            gh run download -n $name -D $SHA_DIR || echo "âš ï¸ $name not found"
          done

      - name: Compare SHAs and set output
        id: compare
        run: |
          echo "should_trigger_build=false" >> $GITHUB_OUTPUT
          changed=false

          if [ ! -f "$SHA_DIR/previous_612.sha" ]; then
            echo "ğŸ†• First run for 6.12"
            mv "$SHA_DIR/current_612.sha" "$SHA_DIR/previous_612.sha"
            changed=true
          elif ! cmp -s "$SHA_DIR/previous_612.sha" "$SHA_DIR/current_612.sha"; then
            echo "ğŸ” Detected change in 6.12"
            mv "$SHA_DIR/current_612.sha" "$SHA_DIR/previous_612.sha"
            changed=true
          fi

          if [ ! -f "$SHA_DIR/previous_66.sha" ]; then
            echo "ğŸ†• First run for 6.6"
            mv "$SHA_DIR/current_66.sha" "$SHA_DIR/previous_66.sha"
            changed=true
          elif ! cmp -s "$SHA_DIR/previous_66.sha" "$SHA_DIR/current_66.sha"; then
            echo "ğŸ” Detected change in 6.6"
            mv "$SHA_DIR/current_66.sha" "$SHA_DIR/previous_66.sha"
            changed=true
          fi

          if [ "$changed" = true ]; then
            echo "âœ… Triggering build"
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
          else
            echo "â¹ No changes in monitored files"
          fi

      - name: Upload new SHA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: makefile-6.12-sha
          path: $SHA_DIR/previous_612.sha
          retention-days: 7

      - name: Upload new SHA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: makefile-6.6-sha
          path: $SHA_DIR/previous_66.sha
          retention-days: 7

      - name: Trigger kernel build workflow
        if: steps.compare.outputs.should_trigger_build == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel  # âš ï¸ è¯·ç¡®è®¤ç›®æ ‡ workflow åç§°æ˜¯å¦å®Œå…¨åŒ¹é…
          token: ${{ secrets.GITHUB_TOKEN }}
