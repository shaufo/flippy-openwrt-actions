name: Check make.env Changes and Trigger Build

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Set URL and Temp Path
        id: setup
        run: |
          echo "MAKEENV_URL=https://raw.githubusercontent.com/unifreq/openwrt_packit/0a8e64cd58d5641b6e58caed59c1ac9c79c7b23c/make.env" >> $GITHUB_ENV
          echo "TEMP_SHA_PATH=./current.sha" >> $GITHUB_ENV
          echo "PREV_SHA_PATH=./previous.sha" >> $GITHUB_ENV

      - name: Download remote make.env
        run: |
          if ! curl -fsSL "$MAKEENV_URL" -o make.env; then
            echo "Failed to download make.env"
            exit 1
          fi

      - name: Calculate hash
        run: |
          sha256sum make.env | awk '{print $1}' > $TEMP_SHA_PATH
          echo "Current SHA: $(cat $TEMP_SHA_PATH)"

      - name: Restore cached hash
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.PREV_SHA_PATH }}
          key: makeenv-sha-${{ github.ref }}-${{ hashFiles('make.env') }}
          restore-keys: |
            makeenv-sha-${{ github.ref }}-
            makeenv-sha-

      - name: Check for change
        id: compare
        run: |
          # 设置默认值
          echo "should_save_cache=true" >> $GITHUB_OUTPUT
          echo "should_trigger_build=false" >> $GITHUB_OUTPUT
          
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" != 'true' ]; then
            echo "No cache found - first run"
            echo "should_save_cache=true" >> $GITHUB_OUTPUT
          elif [ ! -f "$PREV_SHA_PATH" ]; then
            echo "No previous SHA file"
            echo "should_save_cache=true" >> $GITHUB_OUTPUT
          elif ! cmp -s "$PREV_SHA_PATH" "$TEMP_SHA_PATH"; then
            echo "SHA changed - triggering build"
            echo "should_save_cache=true" >> $GITHUB_OUTPUT
            echo "should_trigger_build=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected"
            echo "should_save_cache=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache new hash
        if: steps.compare.outputs.should_save_cache == 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.TEMP_SHA_PATH }}
          key: makeenv-sha-${{ github.ref }}-${{ hashFiles('make.env') }}
          restore-keys: |
            makeenv-sha-${{ github.ref }}-
            makeenv-sha-

      - name: Trigger kernel build workflow
        if: steps.compare.outputs.should_trigger_build == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Compile the kernel
          token: ${{ secrets.GITHUB_TOKEN }}
